<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Timeline Soutenance</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #0f0f0f;
  color: #eee;
  padding: 30px;
}

h1 { text-align: center; }

#globalTime {
  text-align: center;
  font-size: 2.3em;
  margin-bottom: 20px;
}

.timeline {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 10px;
  margin-bottom: 25px;
}

.block {
  padding: 14px;
  border-radius: 10px;
  text-align: center;
  background: #222;
  opacity: 0.4;
  transition: background 0.3s, transform 0.2s;
}

.block.done {
  background: #444;
  opacity: 0.25;
}

.block.active {
  background: #1f6feb;
  opacity: 1;
  transform: scale(1.05);
}

.block.active.orange {
  background: #d29922;
}

.block.active.red {
  background: #da3633;
}

.block.next {
  background: #2ea043;
  opacity: 0.7;
}

.title { font-weight: bold; }
.time { font-size: 0.85em; opacity: 0.8; }

.progress-container {
  background: #222;
  border-radius: 8px;
  height: 14px;
  overflow: hidden;
  margin-bottom: 15px;
}

.progress-bar {
  height: 100%;
  background: #1f6feb;
  width: 0%;
  transition: width 0.3s ease;
}

#sectionTime {
  text-align: center;
  font-size: 1.6em;
  margin-bottom: 20px;
}

.controls {
  display: flex;
  justify-content: center;
  gap: 15px;
  flex-wrap: wrap;
}

button {
  padding: 12px 20px;
  font-size: 1em;
  cursor: pointer;
  border: none;
  border-radius: 6px;
  background: #1f6feb;
  color: white;
  transition: background 0.2s;
}

button:hover {
  background: #1a5acc;
}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
</style>
</head>

<body>

<h1>Timeline Soutenance</h1>

<div id="globalTime">00:00</div>

<div class="timeline" id="timeline"></div>

<div class="progress-container">
  <div class="progress-bar" id="progress"></div>
</div>

<div id="sectionTime">Prêt</div>

<div class="controls">
  <button id="startBtn" onclick="start()">Lancer</button>
  <button id="skipBtn" onclick="skipSection()" disabled>Section suivante</button>
  <button id="lateBtn" onclick="iAmLate()" disabled>Je suis en retard</button>
</div>

<script>
/* ================= CONFIG ================= */

const initialSchedule = [
  { name: "Intro", duration: 120 },
  { name: "Théorie", duration: 240 },
  { name: "Méthodo", duration: 390 },
  { name: "Résultats", duration: 480 },
  { name: "Takeaways", duration: 120 },
  { name: "Conclusion", duration: 180 },
  { name: "Buffer", duration: 60 }
];

let schedule = [];

/* ================= DOM ELEMENTS ================= */

const timeline = document.getElementById("timeline");
const globalTimeEl = document.getElementById("globalTime");
const sectionTimeEl = document.getElementById("sectionTime");
const progressBar = document.getElementById("progress");
const startBtn = document.getElementById("startBtn");
const skipBtn = document.getElementById("skipBtn");
const lateBtn = document.getElementById("lateBtn");

/* ================= TIMER STATE ================= */

let current = 0;
let sectionRemaining = 0;
let globalElapsed = 0;
let timer = null;
let isRunning = false;

/* ================= HELPERS ================= */

function format(sec) {
  const m = String(Math.floor(sec / 60)).padStart(2, "0");
  const s = String(sec % 60).padStart(2, "0");
  return `${m}:${s}`;
}

function getTotalDuration() {
  return schedule.reduce((sum, section) => sum + section.duration, 0);
}

function updateButtons() {
  skipBtn.disabled = !isRunning || current >= schedule.length - 1;
  lateBtn.disabled = !isRunning;
  startBtn.textContent = isRunning ? "Redémarrer" : "Lancer";
}

/* ================= UI ================= */

function renderTimeline() {
  timeline.innerHTML = "";
  schedule.forEach((section, index) => {
    const block = document.createElement("div");
    block.className = "block";
    block.innerHTML = `
      <div class="title">${section.name}</div>
      <div class="time">${Math.round(section.duration / 60)} min</div>
    `;
    timeline.appendChild(block);
  });
  updateTimeline();
}

function updateTimeline() {
  const blocks = timeline.children;
  
  for (let i = 0; i < blocks.length; i++) {
    blocks[i].className = "block";

    if (i < current) {
      blocks[i].classList.add("done");
    } else if (i === current) {
      blocks[i].classList.add("active");

      if (sectionRemaining <= 15) {
        blocks[i].classList.add("red");
      } else if (sectionRemaining <= 30) {
        blocks[i].classList.add("orange");
      }
    } else if (i === current + 1) {
      blocks[i].classList.add("next");
    }
  }
}

function updateDisplay() {
  const total = getTotalDuration();
  
  globalTimeEl.textContent = `Temps : ${format(globalElapsed)} / ${format(total)}`;
  
  if (current < schedule.length) {
    sectionTimeEl.textContent = `${schedule[current].name} – ${format(Math.max(0, sectionRemaining))}`;
  } else {
    sectionTimeEl.textContent = "Terminé";
  }
  
  const progress = Math.min(100, (globalElapsed / total) * 100);
  progressBar.style.width = `${progress}%`;
  
  updateTimeline();
}

/* ================= SECTION MANAGEMENT ================= */

function startSection() {
  if (current < schedule.length) {
    sectionRemaining = schedule[current].duration;
    updateDisplay();
  }
}

function skipSection() {
  if (!isRunning || current >= schedule.length - 1) return;

  const leftover = Math.max(0, sectionRemaining);
  const remaining = schedule.length - current - 1;

  if (remaining > 0 && leftover > 0) {
    const bonus = Math.floor(leftover / remaining);
    for (let i = current + 1; i < schedule.length; i++) {
      schedule[i].duration += bonus;
    }
  }

  current++;
  if (current < schedule.length) {
    startSection();
    renderTimeline();
  } else {
    stopTimer();
  }
  
  updateButtons();
}

function iAmLate() {
  if (!isRunning) return;

  const compressionRatio = 0.85;

  for (let i = current; i < schedule.length; i++) {
    schedule[i].duration = Math.max(
      30,
      Math.floor(schedule[i].duration * compressionRatio)
    );
  }

  sectionRemaining = Math.min(
    sectionRemaining,
    schedule[current].duration
  );

  renderTimeline();
}

/* ================= TIMER CONTROL ================= */

function stopTimer() {
  if (timer) {
    clearInterval(timer);
    timer = null;
  }
  isRunning = false;
  updateButtons();
}

function start() {
  stopTimer();

  // Reset state
  schedule = initialSchedule.map(s => ({ ...s }));
  current = 0;
  globalElapsed = 0;
  isRunning = true;

  renderTimeline();
  startSection();
  updateButtons();

  timer = setInterval(() => {
    sectionRemaining--;
    globalElapsed++;

    updateDisplay();

    if (sectionRemaining <= 0) {
      current++;
      
      if (current < schedule.length) {
        startSection();
        renderTimeline();
      } else {
        stopTimer();
        sectionTimeEl.textContent = "Terminé ✓";
      }
      
      updateButtons();
    }
  }, 1000);
}

/* ================= INITIALIZATION ================= */

schedule = initialSchedule.map(s => ({ ...s }));
renderTimeline();
updateButtons();

</script>

</body>
</html>
